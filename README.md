# Mansa Backend (Django)

## Overview  
A production-ready Django backend skeleton for Mansa. Includes:
- Django 5 + DRF
- Custom User model (email login)
- JWT Auth (SimpleJWT)
- Health check endpoint
- OpenAPI schema & interactive docs (drf-spectacular: /api/schema/, /api/docs/, /api/redoc/)
- Docker + docker-compose (Postgres, Redis)
- Testing (pytest + pytest-django)
- Pre-commit (black, isort, flake8, mypy)
- Environment-based settings (dev/prod)
 - Celery worker & beat (Redis broker)
 - Gunicorn production service
 - Sentry integration (optional via env)
 - DRF throttling (Anon/User) & filtering
 - Coverage reporting (pytest-cov + CI)

## Quick Start (Local)
```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver
```
Visit http://127.0.0.1:8000/api/health/

## Docker
```bash
docker compose build
docker compose up
```

Services:
| Service | Purpose | Port |
|---------|---------|------|
| web | Django dev server (autoreload) | 8000 |
| web_prod | Gunicorn prod server | 8001 |
| db | Postgres 16 | 5432 |
| redis | Redis 7 (broker / cache) | 6379 |
| celery_worker | Asynchronous task worker | - |
| celery_beat | Periodic scheduler | - |

## Auth Flow
1. Register: POST /api/users/register/  {"email": "user@example.com", "password": "StrongPass123"}
2. Obtain Token: POST /api/users/token/  {"email": "user@example.com", "password": "StrongPass123"}
3. Authenticated Me: GET /api/users/me/  (Authorization: Bearer <access token>)

## API Documentation
Schema & UIs generated by drf-spectacular:
| Endpoint | Purpose |
|----------|---------|
| `/api/schema/` | Raw OpenAPI 3.0 schema (JSON) |
| `/api/docs/` | Swagger UI interactive docs |
| `/api/redoc/` | ReDoc documentation |

You can download the schema for client generation:
```bash
curl -H "Accept: application/json" http://127.0.0.1:8000/api/schema/ -o openapi.json
```

## Filtering & Search (Projects)
Projects endpoint supports filtering, ordering, and search when running against Postgres (Supabase). In local sqlite fallback these endpoints return 503.

Query parameters:
| Param | Type | Examples |
|-------|------|----------|
| `status` | exact / in | `?status=open`, `?status__in=open,closed` |
| `project_type` | exact / in | `?project_type=hackathon` |
| `search` | full-text (icontains) | `?search=climate` (matches title/description) |
| `ordering` | field list | `?ordering=title`, `?ordering=-created_at` |

Example:
```
GET /api/platform/projects/?status=open&search=energy&ordering=-created_at
Authorization: Bearer <token>
```

## Tests
```bash
pytest
pytest --cov=apps --cov=config
```

CI will also produce `coverage.xml` and upload to Codecov (configure token if private repo).

## Environment Variables
See `.env.example` for defaults. Important additions:

| Variable | Description | Example |
|----------|-------------|---------|
| DJANGO_SECRET_KEY | Django crypto key | change-me |
| DJANGO_DEBUG | Enable debug | true/false |
| DATABASE_URL | Primary DB (Postgres) | postgres://postgres:postgres@db:5432/mansa |
| SUPABASE_URL | Supabase instance URL | https://xxx.supabase.co |
| SUPABASE_ANON_KEY | Supabase anon key | (string) |
| SUPABASE_SERVICE_ROLE_KEY | Elevated key (secure) | (string) |
| SENTRY_DSN | Enable Sentry if set | https://public@ingest.sentry.io/123 |
| THROTTLE_RATE_ANON | DRF anon rate | 50/min |
| THROTTLE_RATE_USER | DRF user rate | 200/min |
| CELERY_BROKER_URL | Celery broker | redis://redis:6379/0 |
| CELERY_RESULT_BACKEND | Task results (optional) | redis://redis:6379/1 |
| SENTRY_TRACES_SAMPLE_RATE | APM sample rate | 0.1 |
| SENTRY_PROFILES_SAMPLE_RATE | Profiling sample | 0.0 |

If `DATABASE_URL` is absent in tests, sqlite is used automatically.

## Next Steps / Enhancements
- Add domain-specific apps (transactions, products, etc.)
- Pagination tuning & filtering
- Add Postgres-backed test profile & fixtures for platform filtering tests
 - Custom throttle classes / IP blocking
 - Observability (Sentry performance already stubbed, add OpenTelemetry traces)
 - Harden security headers (CSP, Referrer-Policy)
 - Auto-generate client SDK from OpenAPI schema
 - Blue/green deployment workflow & migration safety checks
 - Background domain tasks & scheduled maintenance jobs

## License
MIT (add LICENSE file if required).
